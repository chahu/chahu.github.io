"use strict";class DataManager{constructor(){this.user={},this.routes={},this.events={},this.userCache={}}enrich_csv(t,e){this.counter=void 0===this.counter?1:this.counter,t.forEach((t,e)=>{const s=d3.select("#"+t.wall).node().getPointAtLength(t.offset);t.x=s.x,t.y=s.y,t.offset=parseFloat(t.offset),t.id=++this.counter})}month_exists(t,e){const s=e.substring(0,e.length-1),a=this[`get_min_${s}_date`](),r=this[`get_max_${s}_date`]();return!(t+"-32"<a)&&!(t+"-00">r)}async get_data_for_month(t,e,s=0,a=""){let r=new Date(t.valueOf());if(a=a.toLowerCase(),r.setUTCMonth(r.getUTCMonth()+s),r=date_to_string(r),r=r.substring(0,r.length-3),!this.month_exists(r,e))return[];try{if(this[e][r])this[e][r]instanceof Promise&&await this[e][r];else{this[e][r]=d3.csv(`data/${e}/${a}/${r}.csv`);const t=await this[e][r];this.enrich_csv(t),this[e][r]=t}}catch(t){this[e][r]=[]}return this[e][r]}async get_data(t){const e=t.baseMonth,s=[];for(const a of t.sourceMonths)s.push(this.get_data_for_month(e,t.type,a,t.user));const a=await Promise.all(s);for(const s of t.prefetchMonths)this.get_data_for_month(e,t.type,s,t.user);let r=[];for(const e of a)r=r.concat(e.filter(t.filter));return r}async get_routes(t){const e="string"==typeof t?t:date_to_string(t);return await this.get_data({baseMonth:t,prefetchMonths:[1],sourceMonths:[0,-1,-2,-3],filter:t=>t.start_date<=e&&(t.end_date>=e||!t.end_date),type:"routes"})}async get_events(t){const e="string"==typeof t?t:date_to_string(t);return await this.get_data({baseMonth:t,prefetchMonths:[1],sourceMonths:[0],filter:t=>t.date==e,type:"events",user:this.user.name})}async set_user(t){if(t=t.toLowerCase(),this.userCache[t])return this.user=this.userCache[t].user,this.events=this.userCache[t].events,void(this.avatar=await load_avatar(d3.select("svg"),this.user.name));const e=this.user,s=this.events,a=d3.json(`data/events/${t}.json`);try{this.user=await a,this.user.dateLookup={},this.user.dates.forEach(t=>this.user.dateLookup[t]=!0),this.events={},this.userCache[this.user.name]={user:this.user,events:this.events},this.avatar=await load_avatar(d3.select("svg"),this.user.name)}catch(t){throw this.user=e,this.events=s,t}}has_event(t){return t="string"==typeof t?t:date_to_string(t),this.user.dateLookup[t]}get_min_event_date(){return this.user.min_date}get_max_event_date(){return this.user.max_date}get_min_route_date(){return"2018-08-01"}get_max_route_date(){return date_to_string(new Date)}}
