function load_svg(t,e="img/cliffsmap.svg"){function n(t,e,n){return function(t){const e=n[0].getTotalLength();return d3.interpolateString("0,"+e,e+","+e)(t)}}return d3.xml("img/cliffsmap.svg").then(async e=>{const o="localhost"===location.hostname?100:3e3,r=d3.select(t.node().appendChild(e.documentElement)),i=r.selectAll("g#pads-layer,g#roof-layer,g#structures-layer").style("opacity",0);return r.selectAll("g#walls-layer > path").each((t,e,r)=>{d3.select(r[e]).transition().duration(o).attrTween("stroke-dasharray",n)}),await i.transition().delay(o).duration(1e3).style("opacity",1).end(),r})}function sleep(t){return new Promise(e=>setTimeout(e,t))}function string_to_date(t){const e=t.split("-");return new Date(e[0],e[1]-1,e[2])}function date_to_string(t){return t.toISOString().split("T")[0]}function get_color(t){const e={Red:"#ff0000",Blue:"#0000ff",Green:"#00ff00",Grey:"#888888",Gray:"#888888","Lime Green":"#00d221",White:"#ffffff",Black:"#000000",Purple:"#6d00c1",Pink:"#ffa0e9",Yellow:"#fcdc00",Tan:"#eacca5",Orange:"#ff9000"};for(;!e[t];){let e;if(!(e=t.match(/^(.*) [^ ]+$/)))break;t=e[1]}try{return e[t]}catch(e){return console.log("No color for "+t),console.log(e),"#000000"}}function contrast_color(t,e){return"white"!=t&&"#ffffff"!=t||"#ffffff"!=e&&"white"!=e?t:"#eeeeee"}function avoid_collision(t){const e=avoid_collision;if(e.reset||(e.reset=()=>e.cache={by_wall:{},by_event:{}}),e.cache||(e.cache={by_wall:{},by_event:{}}),e.cache.by_event[t.id])return e.cache.by_event[t.id];const n={"Bouldering 3D":6,"Bouldering Prow":7,"*":8},o=n[t.category]||n["*"],r=e.cache.by_wall,i=e.cache.by_event,l=d3.select("#"+t.wall).node(),c=l.getTotalLength(),a=Math.round(t.offset/o)*o;r[t.wall]||(r[t.wall]={});const s=r[t.wall];if(!s[a])return s[a]=!0,i[t.id]=l.getPointAtLength(a),i[t.id];for(let e=2;;++e){const n=a+Math.trunc(e/2)*(e%2==0?1:-1)*o;if(!s[n]&&n>=0&&n<=c)return s[n]=!0,i[t.id]=l.getPointAtLength(n),i[t.id];if(e>100)return console.log("Couldn't avoid a collision with data:"),console.log(t),{x:t.x,y:t.y}}}function point_distance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}function get_length_at_point(t,e,n){return function e(n,o,r,i,l,c){const a=(n+o)/2;if(o-n<i)return l?{length:a,distance:c}:a;const s=[],g=(o-n)/49;let d;for(let e=0;e<50;++e){const o=n+g*e,i=t.getPointAtLength(o),l=point_distance(i,r);s.push({length:o,point:i,distance:l}),(void 0===d||l<s[d].distance)&&(d=e)}return e(s[0==d?0:d-1].length,s[49==d?d:d+1].length,r,i,l,s[d].distance)}(0,(t="string"==typeof t?document.getElementById(t):t).getTotalLength(),e=void 0===e.x?{x:e[0],y:e[1]}:e,.001,n)}function hover(t,e){const n=$("#info_div"),o=$("#svg_container svg"),r=o.get(0).getBoundingClientRect(),i=o.get(0).getScreenCTM(),l=["x","y","offset","route_id","id","wall","start_date","end_date","event"],c={route_color:"Color",route_grade:"Grade",type:"Type",category:"Wall",rating:"Rating"};let a=i.a*e.x+i.c*e.y+i.e-r.x,s=i.b*e.x+i.d*e.y+i.f-r.y,g="";if(Object.keys(t).forEach(e=>{if(l.includes(e)||""==t[e])return;let n=t[e];if("route_color"==e&&(bg_color=get_color(t.route_color),border_color=contrast_color(get_color(t.route_color),"white"),style=`border-color:${border_color};background-color:${bg_color}`,n=`<div class='swatch_color' style='${style}'></div> ${n}`),"rating"==e){if(!n)return;let t="";n>=4?t='<img src="img/thumbsup.png">':n<=2&&(t='<img src="img/thumbsdown.png">'),n=`${n}/5 ${t}`}g+=`<div>${c[e]}: ${n}</div>\n`}),t.event){if(g+="<hr>",t.event.rating){let e="";t.event.rating>3?e='<img src="img/thumbsup.png">':t.event.rating>0&&t.event.rating<3&&(e='<img src="img/thumbsdown.png">'),console.log(e),g+=`<div>User Rating: ${t.event.rating} ${e}</div>\n`}if(t.event.style){let e="";"Onsight"!=t.event.style&&"Flash"!=t.event.style||(e='<img src="img/flash.png">'),g+=`<div>Style: ${t.event.style} ${e}</div>\n`}if(t.event.comment){g+=`<div>User Comment: ${'<img src="img/comment.png">'} ${t.event.comment}</div>\n`}}n.html(g),e.x>o.outerWidth()/2&&(a-=n.outerWidth(!0)),e.y>o.outerHeight()/2&&(s-=n.outerHeight(!0)),d3.select("#info_div").transition().duration(100).style("opacity",1).style("border-color",contrast_color(get_color(t.route_color),"white")).style("left",a+"px").style("top",s-18+"px")}
