"use strict";function get_color(t){const e={Red:"#ff0000",Blue:"#0000ff",Green:"#00ff00",Grey:"#888888",Gray:"#888888","Lime Green":"#00d221",White:"#ffffff",Black:"#000000",Purple:"#6d00c1",Pink:"#ffa0e9",Yellow:"#fcdc00",Tan:"#eacca5"};return e[t]||(t=t.match(/^(.*) [^ ]+$/)[1]),e[t]}function init_svg(){d3.select("svg").append("g").attr("id","events")}function init_controls(t){let e,o;function n(n){const i=t.filter(t=>t.date==n);avoid_collision("reset"),update(i),$("#current_date").text(n),$("#current_count").text(`(${i.length})`),$("#next_date").prop("disabled",n==e),$("#prev_date").prop("disabled",n==o)}t.forEach(t=>{(!e||t.date>e)&&(e=t.date),(!o||t.date<o)&&(o=t.date)}),$("#prev_date").click(()=>{const e=$("#current_date").text();let o;t.forEach(t=>{t.date<e&&(!o||t.date>o)&&(o=t.date)}),o&&n(o)}),$("#next_date").click(()=>{const e=$("#current_date").text();let o;t.forEach(t=>{t.date>e&&(!o||t.date<o)&&(o=t.date)}),o&&n(o)}),n(t[Math.trunc(t.length/2)].date)}function hover(t,e){const o=$("#info_div"),n=$("#svg_container svg"),i=n.get(0).getBoundingClientRect(),c=n.get(0).getScreenCTM(),l=["x","y","offset","route_id","row_num"];let r=c.a*e.x+c.c*e.y+c.e-i.x,a=c.b*e.x+c.d*e.y+c.f-i.y,d="";Object.keys(t).forEach(e=>{l.includes(e)||""==t[e]||(d+=`<div>${e}: ${t[e]}</div>\n`)}),o.html(d),e.x>n.outerWidth()/2&&(r-=o.outerWidth(!0)),e.y>n.outerHeight()/2&&(a-=o.outerHeight(!0)),d3.select("#info_div").transition().duration(100).style("opacity",1).style("border-color",get_color(t.route_color)).style("left",r+"px").style("top",a+"px")}function update(t){const e=d3.select("#events").selectAll("circle.event").data(t,t=>t.row_num);console.log(t),e.enter().append("circle").attr("class","event").attr("fill",t=>get_color(t.route_color)).attr("stroke","white").attr("stroke-width","2").attr("cx",t=>t.x).attr("cy",t=>t.y).attr("r",0).on("mouseover",t=>hover(t,avoid_collision(t))).on("mouseout",(t,e,o)=>{d3.select("#info_div").transition().delay(200).duration(100).style("opacity",0)}).on("click",t=>window.open("https://www.vertical-life.info/en/indoor/the-cliffs-at-lic/climbs/"+t.route_id,"_blank")).transition().attr("r",5).transition().attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y),e.transition().duration(500).attr("fill",t=>get_color(t.route_color)).attr("r",5),e.exit().remove()}function avoid_collision(t){if(avoid_collision.cache||(avoid_collision.cache={by_wall:{},by_event:{}}),"reset"===t)return avoid_collision.cache={by_wall:{},by_event:{}};if(avoid_collision.cache.by_event[t.row_num])return avoid_collision.cache.by_event[t.row_num];const e=avoid_collision.cache.by_wall,o=avoid_collision.cache.by_event,n=d3.select("#"+t.wall).node(),i=n.getTotalLength(),c=8*Math.round(t.offset/8);e[t.wall]||(e[t.wall]={});const l=e[t.wall];if(!l[c])return l[c]=!0,o[t.row_num]={x:t.x,y:t.y},o[t.row_num];for(let e=2;;++e){const r=Math.trunc(e/2)*(e%2==0?1:-1)*8,a=c+r,d=t.offset+r;if(!l[a]&&d>=0&&d<=i)return l[a]=!0,o[t.row_num]=n.getPointAtLength(d),o[t.row_num];if(e>100)return console.log("Couldn't avoid a collision with data:"),console.log(t),{}}}$(document).ready(async()=>{const t=d3.select("#svg_container");d3.xml("img/cliffsmap.svg").then(e=>{t.node().append(e.documentElement),init_svg()}).then(()=>{d3.csv("events/charlie.csv").then(t=>{t.forEach((t,e)=>{const o=d3.select("#"+t.wall).node().getPointAtLength(t.offset);t.x=o.x,t.y=o.y,t.offset=parseFloat(t.offset),t.row_num=e}),init_controls(t)})})});
