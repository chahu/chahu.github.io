"use strict";$(document).ready(async()=>{const t=d3.select("#svg_container"),e=await load_svg(t),a=await d3.csv("data/routes.csv"),r=await d3.csv("data/charlie.csv");let n,o,i,l,s,c=!1,d=!1;const g=597,h=660;async function f(t){t instanceof Date&&(t=date_to_string(t));const e=a.filter(e=>e.start_date<=t&&(e.end_date>=t||!e.end_date)).map(t=>Object.assign(Object.assign({},t),{event:void 0}));e.sort((t,e)=>t.category==e.category?t.offset-e.offset:t.category>e.category?1:-1),avoid_collision.reset&&avoid_collision.reset();const n=r.filter(e=>e.date==t).length;$("#current_count").text(n+" events, "+e.length+" routes"),c&&B(e);for(let a=0;a<e.length;++a){const r=o[`${e[a].route_id}:${t}`];if(r){const t=Object.assign({},e[a]);if(t.event=r,e[a]=t,c&&(await _(t),P(t),B(e,t.id),await w(),!c))return void await m()}}c&&await m(),c||await B(e)}async function u(t,e=200){const a=[];for(const[r,n]of Object.entries(t))for(const t of{left_leg:{forward:[["avatar-left-leg-forward","translate(0 0) scale(1 1)"],["avatar-left-leg-back","translate(0 327) scale(1 0.5)"]],back:[["avatar-left-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-left-leg-back","translate(0 0) scale(1 1)"]],center:[["avatar-left-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-left-leg-back","translate(0 327) scale(1 0.5)"]]},right_leg:{forward:[["avatar-right-leg-forward","translate(0 0) scale(1 1)"],["avatar-right-leg-back","translate(0 327) scale(1 0.5)"]],back:[["avatar-right-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-right-leg-back","translate(0 0) scale(1 1)"]],center:[["avatar-right-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-right-leg-back","translate(0 327) scale(1 0.5)"]]},left_arm:{forward:[["avatar-left-arm-forward","translate(0 0) scale(1 1) rotate(0 576.5 662.5)"],["avatar-left-arm-back","translate(5 320) scale(1 0.5) rotate(0 576.5 662.5)"]],back:[["avatar-left-arm-forward","translate(0 366) scale(1 0.45) rotate(0 576.5 662.5)"],["avatar-left-arm-back","translate(0 0) scale(1 1) rotate(0 576.5 662.5)"]],center:[["avatar-left-arm-forward","translate(0 366) scale(1 0.45) rotate(0 576.5 662.5)"],["avatar-left-arm-back","translate(5 330) scale(1 0.5) rotate(0 576.5 662.5)"]],open:[["avatar-left-arm-forward","translate(0, 0) scale(1,1) rotate(-80 576.5 662.5)"]],extended:[["avatar-left-arm-forward","translate(0, 0) scale(1,1) rotate(0 576.5 662.5)"]]},right_arm:{forward:[["avatar-right-arm-forward","translate(0 0) scale(1 1) rotate(0 617.5 662.5)"],["avatar-right-arm-back","translate(-5 330) scale(1 0.5) rotate(0 617.5 662.5)"]],back:[["avatar-right-arm-forward","translate(0 366) scale(1 0.45) rotate(0 617.5 662.5)"],["avatar-right-arm-back","translate(0 0) scale(1 1) rotate(0 617.5 662.5)"]],center:[["avatar-right-arm-forward","translate(0 366) scale(1 0.45) rotate(0 617.5 662.5)"],["avatar-right-arm-back","translate(-5 330) scale(1 0.5) rotate(0 617.5 662.5)"]],open:[["avatar-right-arm-forward","translate(0, 0) scale(1,1) rotate(80 617.5 662.5)"]],extended:[["avatar-right-arm-forward","translate(0, 0) scale(1,1) rotate(0 617.5 662.5)"]]},head:{left:[["avatar-head","translate(-3 0)"]],right:[["avatar-head","translate(3 0)"]],center:[["avatar-head","translate(0 0)"]]},torso:{right:[["avatar-torso",`rotate(-10 ${g} ${h})`]],left:[["avatar-torso",`rotate(10 ${g} ${h})`]],center:[["avatar-torso",`rotate(0 ${g} ${h})`]]}}[r][n]){const r=d3.select("#"+t[0]),n=r.attr("transform");r.interrupt(),a.push(r.transition().duration(e).ease(d3.easeLinear).attrTween("transform",()=>d3.interpolate(n,t[1])).end())}await Promise.all(a)}async function w(){const t=[{right_arm:"open",left_arm:"open"},{right_arm:"extended",left_arm:"extended"}];await u(t[0],50),await u(t[1],50),await u(t[0],50),await u(t[1],50),await u(t[0],50),await u(t[1],50)}async function y(){d=!1;await u({right_arm:"center",left_arm:"center",right_leg:"center",left_leg:"center",head:"center",torso:"center"},0)}async function _(t){let e=void 0;if(void 0!==t.category){e=t.category;const a=t.wall;t=function(t,e,a){t={x:t.x,y:t.y};const r=document.getElementById(e),n=get_length_at_point(r,t),o=r.getPointAtLength(Math.min(n+10,r.getTotalLength())),i=r.getPointAtLength(Math.max(n-10,0)),l=-1/((o.y-i.y)/(o.x-i.x));let s,c;l==1/0||l==-1/0?(s=0,c=50):0==l?(s=50,c=0):(s=50*Math.sqrt(1/(1+l*l)),c=l*s);const d={x:t.x+s,y:t.y+c,original:t},g={x:t.x-s,y:t.y-c,original:t},h=M(t,a).walkway,f=get_length_at_point(h,d,!0).distance,u=get_length_at_point(h,g,!0).distance;return f<u?d:g}(t={x:avoid_collision(t).x,y:avoid_collision(t).y},a,e)}void 0===i&&(i="walkway-entrance",await s.transition().duration(0).attrTween("transform",b("walkway-entrance",0,0)).end(),await y(),$("#avatar-layer").show(),l=0);const a=function(t,e,a){const r=M(t,e);return function(t,e){if(t===e)return[[e]];return function t(a,r={}){function r(t,e){return e.result.filter(e=>e[0]==t).length>0}for(const t of a){const a=n[t.path][e];if(a)return t.result.concat([[e,a]])}const o=[];for(const t of a)for(const[e,a]of Object.entries(n[t.path]))if(!r(e,t)){const r={path:e,result:t.result.concat([[e,a]])};o.push(r)}return t(o)}([{path:t,result:[[t]]}])}(a,r.walkway).concat([[r.walkway,{length1:r.length,length2:r.length}]])}(t,e,i);if(async function(){const t=[{right_arm:"forward",left_arm:"back",right_leg:"back",left_leg:"forward",head:"left",torso:"right"},{right_arm:"center",left_arm:"center",right_leg:"center",left_leg:"center",head:"center",torso:"center"},{right_arm:"back",left_arm:"forward",right_leg:"forward",left_leg:"back",head:"right",torso:"left"},{right_arm:"center",left_arm:"center",right_leg:"center",left_leg:"center",head:"center",torso:"center"}];d=!0;let e=0;try{for(;d;)await u(t[e]),e=(e+1)%t.length}catch(t){}}(),point_distance(v(),t)>50){void 0===l&&await A(i),a.shift()[0]!==i&&await A(i);for(const[t,e]of a)await x(i,l,e.length1),i=t,l=e.length2}if(await T(t),t.original){const e=d3.interpolate(v(),t.original);await T(e(.01))}await y()}async function m(){await _(document.getElementById("walkway-entrance").getPointAtLength(0))}function v(t,e){let a;return s.attr("transform")&&(a=s.attr("transform").match("translate\\((\\S+) (\\S+)\\)( rotate\\((\\S+))?")),{x:(a?parseFloat(a[1]):0)+g,y:(a?parseFloat(a[2]):0)+h}}function p(t){const e=v();return()=>{let a=e;return e=>{const r=t(e),n=function(t,e){const a=t.x-e.x,r=t.y-e.y;return Math.atan2(r,a)/Math.PI*180-90}(a,r),o=r.x-g,i=r.y-h;return a={x:r.x,y:r.y},`translate(${o} ${i}) rotate(${n} ${g} ${h})`}}}function b(t,e,a){t="string"==typeof t?document.getElementById(t):t;const r=d3.interpolate(e,a);return p(e=>t.getPointAtLength(r(e)))}function k(t){const e=v();return p(d3.interpolate(e,t))}async function x(t,e,a){t="string"==typeof t?document.getElementById(t):t,await s.transition().duration(L(t.getPointAtLength(e),t.getPointAtLength(a))).ease(d3.easeLinear).attrTween("transform",b(t,e,a)).end(),i=t.getAttribute("id"),l=a}async function T(t){await s.transition().duration(L(v(),t)).ease(d3.easeLinear).attrTween("transform",k(t)).end(),l=void 0}async function A(t){t="string"==typeof t?document.getElementById(t):t;const e=v(),a=get_length_at_point(t,e),r=t.getPointAtLength(a);await s.transition().duration(L(e,r)).ease(d3.easeLinear).attrTween("transform",k(r)).end(),i=t.getAttribute("id"),l=a}function L(t,e){return 3*point_distance(t,e)}async function D(t,e){t=new Date(t.valueOf()),e=new Date(e.valueOf()),t.setUTCHours(18),e.setUTCHours(6);const a=Math.abs(e.getTime()-t.getTime())/864e5,r=d3.interpolate(t.getTime(),e.getTime()),n=[],o=1e3*Math.log2(1+a);$("#clock-layer").show(),n.push(d3.select("#clock_minute_hand").transition().duration(o).attrTween("transform",()=>t=>`rotate(${r(t)%36e5*360/36e5} 600 347)`).end()),n.push(d3.select("#clock_hour_hand").transition().duration(o).attrTween("transform",()=>t=>`rotate(${r(t)%432e5*360/432e5} 600 347)`).end()),n.push(d3.select("#clock-overlay").transition().duration(o).attrTween("opacity",()=>t=>{const e=new Date(r(t)),a=e.getUTCHours()+e.getUTCMinutes()/60+e.getUTCSeconds()/3600;return(Math.max(6,Math.abs(a-12))-6)/6*.3}).end()),n.push(d3.select("#clock-text-date").transition().duration(o).textTween(()=>t=>{const e=new Date(r(t));return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getUTCMonth()]} ${e.getUTCDate().toString().padStart(2,"0")}, ${e.getFullYear()}`}).end()),$("#clock-text").text(`+${Math.ceil(a)} ${a>1?"Days":"Day"}`),await Promise.all(n),$("#clock-layer").hide()}function M(t,e){let a,r,n;const o={"Routes Island High Bay Left":"walkway-lowbay-right","Routes Island Low Bay Right":"walkway-highbays","Routes Lead Cave":"walkway-lowbay-right","Bouldering 45":"walkway-mezzanine","Bouldering Buddha":"walkway-mezzanine","Bouldering Slab":"walkway-fox","Routes Right of Auto Belay":"walkway-mezzanine","Routes Auto Belays":"walkway-mezzanine"}[e];for(const e of $("#walkways-layer path")){if(e.getAttribute("id")===o)continue;const i=get_length_at_point(e,t,!0);(null==n||i.distance<n)&&(n=i.distance,a=e.getAttribute("id"),r=i.length)}return{walkway:a,length:r,distance:n}}async function P(t){const a={x:avoid_collision(t).x,y:avoid_collision(t).y},r=[],n=t.event.route_grade.match("^(5\\.)?(.*)")[2];r.push({color:"#800080",text:n}),1==t.event.rating&&r.push({href:"img/thumbsdown.png",width:50,height:50}),2==t.event.rating&&r.push({href:"img/thumbsdown.png"}),4==t.event.rating&&r.push({href:"img/thumbsup.png"}),5==t.event.rating&&r.push({href:"img/thumbsup.png",width:50,height:50}),t.event.comment.length>0&&r.push({href:"img/comment.png"}),"Flash"!=t.event.style&&"Onsight"!=t.event.style||r.push({href:"img/flash.png",height:28,width:25}),async function(t,a){let r=0;for(const n of t){if(n.duration=n.duration||2e3,n.width=n.width||30,n.height=n.height||30,n.href){const t=e.append("image");t.attr("href",n.href).attr("x",a.x-n.width/2).attr("y",a.y-n.height/2).attr("width",n.width).attr("height",n.height).attr("opacity",0).transition().delay(r).duration(n.duration).attr("y",a.y-50).attrTween("opacity",()=>t=>1-Math.abs(2*t-1)).on("end",()=>t.remove()).end()}else if(n.text){const t=e.append("circle");t.attr("fill",n.color).attr("cx",a.x).attr("cy",a.y).attr("r",n.r||12).attr("opacity",0).transition().delay(r).duration(n.duration).attr("cy",a.y-50).attr("opacity",1).attrTween("opacity",()=>t=>1-Math.abs(2*t-1)).on("end",()=>t.remove()).end();const o=e.append("text");o.attr("text-anchor","middle").attr("x",a.x).attr("y",a.y+5.4).attr("width",50).attr("height",10).attr("fill","white").attr("font-family","Roboto Condensed").attr("font-size","0.85em").attr("font-weight","bold").text(n.text).attr("opacity",0).transition().delay(r).duration(n.duration).attr("y",a.y-50+5.4).attr("opacity",1).attrTween("opacity",()=>t=>1-Math.abs(2*t-1)).on("end",()=>o.remove()).end()}r+=500}}(r,a)}async function B(t,e){const a=d3.select("#routes").selectAll("circle.route").data(t,t=>`${t.id}:${t.event?"1":"0"}`),r=e?t=>t.id==e:t=>!0,n=a.enter().append("circle").attr("class","route").attr("opacity",1).attr("fill",t=>get_color(t.route_color)).attr("fill-opacity",0).attr("stroke",t=>get_color(t.route_color)).attr("stroke-width",1).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).attr("r",t=>t.event?30:5).on("mouseover",t=>hover(t,avoid_collision(t))).on("mouseout",(t,e,a)=>{d3.select("#info_div").transition().delay(200).duration(100).style("opacity",0)}).on("dblclick",t=>window.open("https://www.vertical-life.info/en/indoor/the-cliffs-at-lic/climbs/"+t.route_id,"_blank")).filter(r).transition().duration(1e3).attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).end(),o=a.filter(r).transition().duration(1e3).attr("fill",t=>get_color(t.route_color)).attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).end(),i=a.exit().filter(r).transition().duration(1e3).attr("r",20).attr("opacity",0).remove().end();await Promise.all([n,o,i])}$("#controls").show(),$("#stop_button").hide(),[a,r].forEach(t=>{t.forEach((t,e)=>{const a=d3.select("#"+t.wall).node().getPointAtLength(t.offset);t.x=a.x,t.y=a.y,t.offset=parseFloat(t.offset),t.id=e})}),function(){e.insert("g","#clock-layer").attr("id","events"),e.insert("g","#clock-layer").attr("id","routes"),s=e.select("#avatar-layer"),n=function(){const t={},e=$("#walkways-layer path");for(const a of e){const r=a.getAttribute("id"),n=a.getPointAtLength(0),o=a.getPointAtLength(a.getTotalLength());let i,l;for(const s of e){const e=s.getAttribute("id");let c;a!==s&&(s.isPointInStroke(n)?(c=n,i=0):s.isPointInStroke(o)&&(c=o,i=a.getTotalLength()),c&&(l=get_length_at_point(s,c),t[r]=t[r]||{},t[e]=t[e]||{},t[r][e]={length1:i,length2:l},t[e][r]={length1:l,length2:i}))}}return t}(),o=Object.fromEntries(r.map(t=>[`${t.route_id}:${t.date}`,t]));const t={};r.forEach(e=>t[e.date]=!0);const a=r.reduce((t,e)=>t.date>e.date?t:e).date,i=r.reduce((t,e)=>t.date<e.date?t:e).date,l=new Pikaday({field:document.getElementById("current_date"),position:"top right",disableDayFn:e=>!t[date_to_string(e)],onSelect:t=>f(t)});function d(e){const r=l.getDate();do{if(e>0&&r>string_to_date(a))return;if(e<0&&r<string_to_date(i))return;r.setDate(r.getDate()+e)}while(!t[date_to_string(r)]);return l.setDate(r,c),r}l.setDate(string_to_date("2020-01-03")),$("#next_date").click(()=>d(1)),$("#previous_date").click(()=>d(-1)),$("#play_button").click(async()=>{for($("#play_button").hide(),$("#stop_button").show(),c=!0;l.getDate()<string_to_date(a);){const t=l.getDate(),e=d(1);if(await D(t,e),await f(e),!c)break}c=!1,$("#play_button").show(),$("#stop_button").hide()}),$("#stop_button").click(()=>{c=!1,$("#play_button").show(),$("#stop_button").hide()})}()});
