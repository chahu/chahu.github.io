"use strict";$(document).ready(async()=>{const t=d3.select("#svg_container"),e=await load_svg(t),o=await d3.csv("data/routes.csv"),a=await d3.csv("data/charlie.csv");let n,i,r,c,s,l=!1;async function d(t){t instanceof Date&&(t=date_to_string(t));const e=o.filter(e=>e.start_date<=t&&(e.end_date>=t||!e.end_date)).map(t=>Object.assign(Object.assign({},t),{event:void 0}));e.sort((t,e)=>t.category==e.category?t.offset-e.offset:t.category>e.category?1:-1),avoid_collision.reset&&avoid_collision.reset();const n=a.filter(e=>e.date==t).length;$("#current_count").text(n+" events, "+e.length+" routes"),l&&w(e);for(let o=0;o<e.length;++o){const a=i[`${e[o].route_id}:${t}`];if(a){const t=Object.assign({},e[o]);if(t.event=a,e[o]=t,l&&(await g(t),await w(e),!l))return void await u()}}l&&await u(),l||await w(e)}async function u(){await g(document.getElementById("walkway-entrance").getPointAtLength(0))}async function g(t){let e=void 0;if(void 0!==t.category&&(e=t.category,t={x:avoid_collision(t).x,y:avoid_collision(t).y}),void 0===r){const t=document.getElementById("walkway-entrance").getPointAtLength(0);s.attr("r",15).attr("stroke","black").attr("stroke-width",2).attr("fill","none").attr("cx",t.x).attr("cy",t.y),r="walkway-entrance",c=0}const o=function(t,e,o,a){let i,r,c;const s={"Routes Island High Bay Left":"walkway-lowbay-right","Routes Island Low Bay Right":"walkway-highbays","Routes Lead Cave":"walkway-lowbay-right","Bouldering 45":"walkway-mezzanine","Bouldering Buddha":"walkway-mezzanine","Routes Right of Auto Belay":"walkway-mezzanine","Routes Auto Belays":"walkway-mezzanine"}[e];for(const e of $("#walkways-layer path")){if(e.getAttribute("id")===s)continue;const o=get_length_at_point(e,t,!0);(null==c||o.distance<c)&&(c=o.distance,i=e.getAttribute("id"),r=o.length)}return function(t,e){if(t===e)return[[e]];return function t(o){for(const t of o){const o=n[t.path][e];if(o)return t.result.concat([[e,o]])}const a=[];for(const t of o)for(const[e,o]of Object.entries(n[t.path])){const n={path:e,result:t.result.concat([[e,o]])};a.push(n)}return t(a)}([{path:t,result:[[t]]}])}(o,i).concat([[i,{length1:r,length2:r}]])}(t,e,r),a={x:parseFloat(s.attr("cx")),y:parseFloat(s.attr("cy"))};if(console.log(point_distance(a,t)),point_distance(a,t)>50){void 0===c&&await h(r),o.shift()[0]!==r&&await h(r);for(const[t,e]of o)await y(r,c,e.length1),r=t,c=e.length2}await async function(t){const e={x:parseFloat(s.attr("cx")),y:parseFloat(s.attr("cy"))};await s.transition().duration(f(e,t)).ease(d3.easeLinear).attr("cx",t.x).attr("cy",t.y).end(),c=void 0}(t)}async function y(t,e,o){t="string"==typeof t?document.getElementById(t):t;const a=d3.interpolate(e,o);await s.transition().duration(f(t.getPointAtLength(e),t.getPointAtLength(o))).ease(d3.easeLinear).attrTween("cx",()=>e=>t.getPointAtLength(a(e)).x).attrTween("cy",()=>e=>t.getPointAtLength(a(e)).y).end(),r=t.getAttribute("id"),c=o}function f(t,e){return 1.5*point_distance(t,e)}async function h(t){t="string"==typeof t?document.getElementById(t):t;const e={x:parseFloat(s.attr("cx")),y:parseFloat(s.attr("cy"))},o=get_length_at_point(t,e),a=t.getPointAtLength(o);await s.transition().duration(f(e,a)).ease(d3.easeLinear).attr("cx",a.x).attr("cy",a.y).end(),r=t.getAttribute("id"),c=o}async function _(t,e){t=new Date(t.valueOf()),e=new Date(e.valueOf()),t.setUTCHours(18),e.setUTCHours(6);const o=Math.abs(e.getTime()-t.getTime())/864e5,a=d3.interpolate(t.getTime(),e.getTime()),n=[],i=1e3*Math.log2(1+o);$("#clock-text").text(`+${Math.ceil(o)} ${o>1?"Days":"Day"}`);$("#clock-layer").show(),n.push(d3.select("#clock_minute_hand").transition().duration(i).attrTween("transform",()=>t=>`rotate(${a(t)%36e5*360/36e5} 600 347)`).end()),n.push(d3.select("#clock_hour_hand").transition().duration(i).attrTween("transform",()=>t=>`rotate(${a(t)%432e5*360/432e5} 600 347)`).end()),n.push(d3.select("#clock-overlay").transition().duration(i).attrTween("opacity",()=>t=>{const e=new Date(a(t)),o=e.getUTCHours()+e.getUTCMinutes()/60+e.getUTCSeconds()/3600;return(Math.max(6,Math.abs(o-12))-6)/6*.3}).end()),await Promise.all(n),$("#clock-layer").hide()}async function w(t){const e=d3.select("#routes").selectAll("circle.route").data(t,t=>`${t.id}:${t.event?"1":"0"}`),o=e.enter().append("circle").attr("class","route").attr("opacity",1).attr("fill",t=>get_color(t.route_color)).attr("fill-opacity",0).attr("stroke",t=>get_color(t.route_color)).attr("stroke-width",1).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).attr("r",t=>t.event?30:5).on("mouseover",t=>hover(t,avoid_collision(t))).on("mouseout",(t,e,o)=>{d3.select("#info_div").transition().delay(200).duration(100).style("opacity",0)}).on("dblclick",t=>window.open("https://www.vertical-life.info/en/indoor/the-cliffs-at-lic/climbs/"+t.route_id,"_blank")).transition().duration(1e3).attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).end(),a=e.transition().duration(1e3).attr("fill",t=>t.event?get_color(t.route_color):"none").attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).end(),n=e.exit().transition().duration(1e3).attr("r",20).attr("opacity",0).remove().end();await Promise.all([o,a,n])}$("#controls").show(),$("#stop_button").hide(),[o,a].forEach(t=>{t.forEach((t,e)=>{const o=d3.select("#"+t.wall).node().getPointAtLength(t.offset);t.x=o.x,t.y=o.y,t.offset=parseFloat(t.offset),t.id=e})}),function(){e.insert("g","#clock-layer").attr("id","events"),e.insert("g","#clock-layer").attr("id","routes"),s=e.insert("circle","#clock-layer").attr("id","climber"),n=function(){const t={},e=$("#walkways-layer path");for(const o of e){const a=o.getAttribute("id"),n=o.getPointAtLength(0),i=o.getPointAtLength(o.getTotalLength());let r,c;for(const s of e){const e=s.getAttribute("id");let l;o!==s&&(s.isPointInStroke(n)?(l=n,r=0):s.isPointInStroke(i)&&(l=i,r=o.getTotalLength()),l&&(c=get_length_at_point(s,l),t[a]=t[a]||{},t[e]=t[e]||{},t[a][e]={length1:r,length2:c},t[e][a]={length1:c,length2:r}))}}return t}(),i=Object.fromEntries(a.map(t=>[`${t.route_id}:${t.date}`,t]));const t={};a.forEach(e=>t[e.date]=!0);const o=a.reduce((t,e)=>t.date>e.date?t:e).date,r=a.reduce((t,e)=>t.date<e.date?t:e).date,c=new Pikaday({field:document.getElementById("current_date"),position:"top right",disableDayFn:e=>!t[date_to_string(e)],onSelect:t=>d(t)});function u(e){const a=c.getDate();do{if(e>0&&a>string_to_date(o))return;if(e<0&&a<string_to_date(r))return;a.setDate(a.getDate()+e)}while(!t[date_to_string(a)]);return c.setDate(a,l),a}c.setDate(string_to_date("2020-01-03")),$("#next_date").click(()=>u(1)),$("#previous_date").click(()=>u(-1)),$("#play_button").click(async()=>{for($("#play_button").hide(),$("#stop_button").show(),l=!0;c.getDate()<string_to_date(o);){console.log(`[${new Date} next_date()]`);const t=c.getDate(),e=u(1);if(await _(t,e),await d(e),console.log(`[${new Date} next_date() finished]`),!l)break}l=!1,$("#play_button").show(),$("#stop_button").hide()}),$("#stop_button").click(()=>{l=!1,$("#play_button").show(),$("#stop_button").hide()})}()});
