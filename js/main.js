"use strict";$(document).ready(async()=>{const t=d3.select("#svg_container"),a=await load_svg(t),e=await d3.csv("data/routes.csv"),r=await d3.csv("data/charlie.csv");let n,o,i,l,s,c=!1,d=!1;const g=597,f=660;async function u(t){t instanceof Date&&(t=date_to_string(t));const a=e.filter(a=>a.start_date<=t&&(a.end_date>=t||!a.end_date)).map(t=>Object.assign(Object.assign({},t),{event:void 0}));a.sort((t,a)=>t.category==a.category?t.offset-a.offset:t.category>a.category?1:-1),avoid_collision.reset&&avoid_collision.reset();const n=r.filter(a=>a.date==t).length;$("#current_count").text(n+" events, "+a.length+" routes"),c&&D(a);for(let e=0;e<a.length;++e){const r=o[`${a[e].route_id}:${t}`];if(r){const t=Object.assign({},a[e]);if(t.event=r,a[e]=t,c&&(await b(t),D(a,t.id),await w(),!c))return void await y()}}c&&await y(),c||await D(a)}async function h(t,a=200){const e=[];for(const[r,n]of Object.entries(t))for(const t of{left_leg:{forward:[["avatar-left-leg-forward","translate(0 0) scale(1 1)"],["avatar-left-leg-back","translate(0 327) scale(1 0.5)"]],back:[["avatar-left-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-left-leg-back","translate(0 0) scale(1 1)"]],center:[["avatar-left-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-left-leg-back","translate(0 327) scale(1 0.5)"]]},right_leg:{forward:[["avatar-right-leg-forward","translate(0 0) scale(1 1)"],["avatar-right-leg-back","translate(0 327) scale(1 0.5)"]],back:[["avatar-right-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-right-leg-back","translate(0 0) scale(1 1)"]],center:[["avatar-right-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-right-leg-back","translate(0 327) scale(1 0.5)"]]},left_arm:{forward:[["avatar-left-arm-forward","translate(0 0) scale(1 1) rotate(0 576.5 662.5)"],["avatar-left-arm-back","translate(5 320) scale(1 0.5) rotate(0 576.5 662.5)"]],back:[["avatar-left-arm-forward","translate(0 366) scale(1 0.45) rotate(0 576.5 662.5)"],["avatar-left-arm-back","translate(0 0) scale(1 1) rotate(0 576.5 662.5)"]],center:[["avatar-left-arm-forward","translate(0 366) scale(1 0.45) rotate(0 576.5 662.5)"],["avatar-left-arm-back","translate(5 330) scale(1 0.5) rotate(0 576.5 662.5)"]],open:[["avatar-left-arm-forward","translate(0, 0) scale(1,1) rotate(-80 576.5 662.5)"]],extended:[["avatar-left-arm-forward","translate(0, 0) scale(1,1) rotate(0 576.5 662.5)"]]},right_arm:{forward:[["avatar-right-arm-forward","translate(0 0) scale(1 1) rotate(0 617.5 662.5)"],["avatar-right-arm-back","translate(-5 330) scale(1 0.5) rotate(0 617.5 662.5)"]],back:[["avatar-right-arm-forward","translate(0 366) scale(1 0.45) rotate(0 617.5 662.5)"],["avatar-right-arm-back","translate(0 0) scale(1 1) rotate(0 617.5 662.5)"]],center:[["avatar-right-arm-forward","translate(0 366) scale(1 0.45) rotate(0 617.5 662.5)"],["avatar-right-arm-back","translate(-5 330) scale(1 0.5) rotate(0 617.5 662.5)"]],open:[["avatar-right-arm-forward","translate(0, 0) scale(1,1) rotate(80 617.5 662.5)"]],extended:[["avatar-right-arm-forward","translate(0, 0) scale(1,1) rotate(0 617.5 662.5)"]]},head:{left:[["avatar-head","translate(-3 0)"]],right:[["avatar-head","translate(3 0)"]],center:[["avatar-head","translate(0 0)"]]},torso:{right:[["avatar-torso",`rotate(-10 ${g} ${f})`]],left:[["avatar-torso",`rotate(10 ${g} ${f})`]],center:[["avatar-torso",`rotate(0 ${g} ${f})`]]}}[r][n]){const r=d3.select("#"+t[0]),n=r.attr("transform");r.interrupt(),e.push(r.transition().duration(a).ease(d3.easeLinear).attrTween("transform",()=>d3.interpolate(n,t[1])).end())}await Promise.all(e)}async function w(){const t=[{right_arm:"open",left_arm:"open"},{right_arm:"extended",left_arm:"extended"}];await h(t[0],50),await h(t[1],50),await h(t[0],50),await h(t[1],50),await h(t[0],50),await h(t[1],50)}async function _(){d=!1;await h({right_arm:"center",left_arm:"center",right_leg:"center",left_leg:"center",head:"center",torso:"center"},0)}async function y(){await b(document.getElementById("walkway-entrance").getPointAtLength(0))}function v(t,a){let e;return s.attr("transform")&&(e=s.attr("transform").match("translate\\((\\S+) (\\S+)\\)( rotate\\((\\S+))?")),{x:(e?parseFloat(e[1]):0)+g,y:(e?parseFloat(e[2]):0)+f}}function m(t){const a=v();return()=>{let e=a;return a=>{const r=t(a),n=function(t,a){const e=t.x-a.x,r=t.y-a.y;return Math.atan2(r,e)/Math.PI*180-90}(e,r),o=r.x-g,i=r.y-f;return e={x:r.x,y:r.y},`translate(${o} ${i}) rotate(${n} ${g} ${f})`}}}function k(t,a,e){t="string"==typeof t?document.getElementById(t):t;const r=d3.interpolate(a,e);return m(a=>t.getPointAtLength(r(a)))}function p(t){const a=v();return m(d3.interpolate(a,t))}async function b(t){let a=void 0;if(void 0!==t.category){a=t.category;const e=t.wall;t=function(t,a,e){t={x:t.x,y:t.y};const r=document.getElementById(a),n=get_length_at_point(r,t),o=r.getPointAtLength(Math.min(n+10,r.getTotalLength())),i=r.getPointAtLength(Math.max(n-10,0)),l=-1/((o.y-i.y)/(o.x-i.x));let s,c;l==1/0||l==-1/0?(s=0,c=50):0==l?(s=50,c=0):(s=50*Math.sqrt(1/(1+l*l)),c=l*s);const d={x:t.x+s,y:t.y+c,original:t},g={x:t.x-s,y:t.y-c,original:t},f=B(t,e).walkway;return get_length_at_point(f,d,!0).distance<get_length_at_point(f,g,!0).distance?d:g}(t={x:avoid_collision(t).x,y:avoid_collision(t).y},e,a)}void 0===i&&(i="walkway-entrance",await s.transition().duration(0).attrTween("transform",k("walkway-entrance",0,0)).end(),await _(),$("#avatar-layer").show(),l=0);const e=function(t,a,e){const r=B(t,a);return function(t,a){if(t===a)return[[a]];return function t(e,r={}){function r(t,a){return a.result.filter(a=>a[0]==t).length>0}for(const t of e){const e=n[t.path][a];if(e)return t.result.concat([[a,e]])}const o=[];for(const t of e)for(const[a,e]of Object.entries(n[t.path]))if(!r(a,t)){const r={path:a,result:t.result.concat([[a,e]])};o.push(r)}return t(o)}([{path:t,result:[[t]]}])}(e,r.walkway).concat([[r.walkway,{length1:r.length,length2:r.length}]])}(t,a,i);if(async function(){const t=[{right_arm:"forward",left_arm:"back",right_leg:"back",left_leg:"forward",head:"left",torso:"right"},{right_arm:"center",left_arm:"center",right_leg:"center",left_leg:"center",head:"center",torso:"center"},{right_arm:"back",left_arm:"forward",right_leg:"forward",left_leg:"back",head:"right",torso:"left"},{right_arm:"center",left_arm:"center",right_leg:"center",left_leg:"center",head:"center",torso:"center"}];d=!0;let a=0;try{for(;d;)await h(t[a]),a=(a+1)%t.length}catch(t){}}(),point_distance(v(),t)>50){void 0===l&&await A(i),e.shift()[0]!==i&&await A(i);for(const[t,a]of e)await x(i,l,a.length1),i=t,l=a.length2}if(await L(t),t.original){const a=d3.interpolate(v(),t.original);await L(a(.01))}await _()}async function x(t,a,e){t="string"==typeof t?document.getElementById(t):t,await s.transition().duration(T(t.getPointAtLength(a),t.getPointAtLength(e))).ease(d3.easeLinear).attrTween("transform",k(t,a,e)).end(),i=t.getAttribute("id"),l=e}async function L(t){await s.transition().duration(T(v(),t)).ease(d3.easeLinear).attrTween("transform",p(t)).end(),l=void 0}function T(t,a){return 3*point_distance(t,a)}async function A(t){t="string"==typeof t?document.getElementById(t):t;const a=v(),e=get_length_at_point(t,a),r=t.getPointAtLength(e);await s.transition().duration(T(a,r)).ease(d3.easeLinear).attrTween("transform",p(r)).end(),i=t.getAttribute("id"),l=e}async function P(t,a){t=new Date(t.valueOf()),a=new Date(a.valueOf()),t.setUTCHours(18),a.setUTCHours(6);const e=Math.abs(a.getTime()-t.getTime())/864e5,r=d3.interpolate(t.getTime(),a.getTime()),n=[],o=1e3*Math.log2(1+e);$("#clock-text").text(`+${Math.ceil(e)} ${e>1?"Days":"Day"}`);$("#clock-layer").show(),n.push(d3.select("#clock_minute_hand").transition().duration(o).attrTween("transform",()=>t=>`rotate(${r(t)%36e5*360/36e5} 600 347)`).end()),n.push(d3.select("#clock_hour_hand").transition().duration(o).attrTween("transform",()=>t=>`rotate(${r(t)%432e5*360/432e5} 600 347)`).end()),n.push(d3.select("#clock-overlay").transition().duration(o).attrTween("opacity",()=>t=>{const a=new Date(r(t)),e=a.getUTCHours()+a.getUTCMinutes()/60+a.getUTCSeconds()/3600;return(Math.max(6,Math.abs(e-12))-6)/6*.3}).end()),await Promise.all(n),$("#clock-layer").hide()}function B(t,a){let e,r,n;const o={"Routes Island High Bay Left":"walkway-lowbay-right","Routes Island Low Bay Right":"walkway-highbays","Routes Lead Cave":"walkway-lowbay-right","Bouldering 45":"walkway-mezzanine","Bouldering Buddha":"walkway-mezzanine","Bouldering Slab":"walkway-fox","Routes Right of Auto Belay":"walkway-mezzanine","Routes Auto Belays":"walkway-mezzanine"}[a];for(const a of $("#walkways-layer path")){if(a.getAttribute("id")===o)continue;const i=get_length_at_point(a,t,!0);(null==n||i.distance<n)&&(n=i.distance,e=a.getAttribute("id"),r=i.length)}return{walkway:e,length:r,distance:n}}async function D(t,a){const e=d3.select("#routes").selectAll("circle.route").data(t,t=>`${t.id}:${t.event?"1":"0"}`),r=a?t=>t.id==a:t=>!0,n=e.enter().append("circle").attr("class","route").attr("opacity",1).attr("fill",t=>get_color(t.route_color)).attr("fill-opacity",0).attr("stroke",t=>get_color(t.route_color)).attr("stroke-width",1).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).attr("r",t=>t.event?30:5).on("mouseover",t=>hover(t,avoid_collision(t))).on("mouseout",(t,a,e)=>{d3.select("#info_div").transition().delay(200).duration(100).style("opacity",0)}).on("dblclick",t=>window.open("https://www.vertical-life.info/en/indoor/the-cliffs-at-lic/climbs/"+t.route_id,"_blank")).filter(r).transition().duration(1e3).attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).end(),o=e.filter(r).transition().duration(1e3).attr("fill",t=>get_color(t.route_color)).attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).end(),i=e.exit().filter(r).transition().duration(1e3).attr("r",20).attr("opacity",0).remove().end();await Promise.all([n,o,i])}$("#controls").show(),$("#stop_button").hide(),[e,r].forEach(t=>{t.forEach((t,a)=>{const e=d3.select("#"+t.wall).node().getPointAtLength(t.offset);t.x=e.x,t.y=e.y,t.offset=parseFloat(t.offset),t.id=a})}),function(){a.insert("g","#clock-layer").attr("id","events"),a.insert("g","#clock-layer").attr("id","routes"),s=a.select("#avatar-layer"),n=function(){const t={},a=$("#walkways-layer path");for(const e of a){const r=e.getAttribute("id"),n=e.getPointAtLength(0),o=e.getPointAtLength(e.getTotalLength());let i,l;for(const s of a){const a=s.getAttribute("id");let c;e!==s&&(s.isPointInStroke(n)?(c=n,i=0):s.isPointInStroke(o)&&(c=o,i=e.getTotalLength()),c&&(l=get_length_at_point(s,c),t[r]=t[r]||{},t[a]=t[a]||{},t[r][a]={length1:i,length2:l},t[a][r]={length1:l,length2:i}))}}return t}(),o=Object.fromEntries(r.map(t=>[`${t.route_id}:${t.date}`,t]));const t={};r.forEach(a=>t[a.date]=!0);const e=r.reduce((t,a)=>t.date>a.date?t:a).date,i=r.reduce((t,a)=>t.date<a.date?t:a).date,l=new Pikaday({field:document.getElementById("current_date"),position:"top right",disableDayFn:a=>!t[date_to_string(a)],onSelect:t=>u(t)});function d(a){const r=l.getDate();do{if(a>0&&r>string_to_date(e))return;if(a<0&&r<string_to_date(i))return;r.setDate(r.getDate()+a)}while(!t[date_to_string(r)]);return l.setDate(r,c),r}l.setDate(string_to_date("2020-01-03")),$("#next_date").click(()=>d(1)),$("#previous_date").click(()=>d(-1)),$("#play_button").click(async()=>{for($("#play_button").hide(),$("#stop_button").show(),c=!0;l.getDate()<string_to_date(e);){const t=l.getDate(),a=d(1);if(await P(t,a),await u(a),!c)break}c=!1,$("#play_button").show(),$("#stop_button").hide()}),$("#stop_button").click(()=>{c=!1,$("#play_button").show(),$("#stop_button").hide()})}()});
