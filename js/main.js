"use strict";$(document).ready(async()=>{const t=d3.select("#svg_container"),e=await load_svg(t),o=await d3.csv("data/routes.csv"),n=await d3.csv("data/charlie.csv");let a,r,i=!1;async function s(t){t instanceof Date&&(t=date_to_string(t));const e=o.filter(e=>e.start_date<=t&&(e.end_date>=t||!e.end_date)).map(t=>Object.assign(Object.assign({},t),{event:void 0}));avoid_collision.reset&&avoid_collision.reset();const a=n.filter(e=>e.date==t).length;$("#current_count").text(a+" events, "+e.length+" routes");for(let o=0;o<e.length;++o){const n=r[`${e[o].route_id}:${t}`];if(n){const t=Object.assign({},e[o]);if(t.event=n,e[o]=t,i&&(await c(e),!i))return}}i||await c(e)}async function c(t){const e=d3.select("#routes").selectAll("circle.route").data(t,t=>`${t.id}:${t.event?"1":"0"}`),o=e.enter().append("circle").attr("class","route").attr("opacity",1).attr("fill",t=>get_color(t.route_color)).attr("fill-opacity",0).attr("stroke",t=>get_color(t.route_color)).attr("stroke-width",1).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).attr("r",t=>t.event?30:5).on("mouseover",t=>hover(t,avoid_collision(t))).on("mouseout",(t,e,o)=>{d3.select("#info_div").transition().delay(200).duration(100).style("opacity",0)}).on("click",t=>window.open("https://www.vertical-life.info/en/indoor/the-cliffs-at-lic/climbs/"+t.route_id,"_blank")).transition().duration(1e3).attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).end(),n=e.transition().duration(1e3).attr("fill",t=>t.event?get_color(t.route_color):"none").attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).end(),a=e.exit().transition().duration(1e3).attr("r",20).attr("opacity",0).remove().end();await Promise.all([o,n,a])}$("#controls").show(),$("#stop_button").hide(),[o,n].forEach(t=>{t.forEach((t,e)=>{const o=d3.select("#"+t.wall).node().getPointAtLength(t.offset);t.x=o.x,t.y=o.y,t.offset=parseFloat(t.offset),t.id=e})}),function(){e.append("g").attr("id","events"),e.append("g").attr("id","routes"),a=function(){const t={},e=$("#walkways-layer path");for(const o of e){const n=o.getAttribute("id"),a=o.getPointAtLength(0),r=o.getPointAtLength(o.getTotalLength());for(const i of e){const e=i.getAttribute("id");let s;o!==i&&(i.isPointInStroke(a)?(s=a,s.length1=0):i.isPointInStroke(r)&&(s=r,s.length1=o.getTotalLength()),s&&(s.length2=get_length_at_point(i,s),t[n]=t[n]||{},t[e]=t[e]||{},t[n][e]=s,t[e][n]=s))}}return t}(),r=Object.fromEntries(n.map(t=>[`${t.route_id}:${t.date}`,t]));const t={};n.forEach(e=>t[e.date]=!0);const o=n.reduce((t,e)=>t.date>e.date?t:e).date,c=n.reduce((t,e)=>t.date<e.date?t:e).date,l=new Pikaday({field:document.getElementById("current_date"),position:"top right",disableDayFn:e=>!t[date_to_string(e)],onSelect:t=>s(t)});function d(e){const n=l.getDate();do{if(e>0&&n>string_to_date(o))return;if(e<0&&n<string_to_date(c))return;n.setDate(n.getDate()+e)}while(!t[date_to_string(n)]);return l.setDate(n,i),n}l.setDate(string_to_date("2020-01-03")),$("#next_date").click(()=>d(1)),$("#previous_date").click(()=>d(-1)),$("#play_button").click(async()=>{for($("#play_button").hide(),$("#stop_button").show(),i=!0;l.getDate()<string_to_date(o);){console.log(`[${new Date} next_date()]`);const t=d(1);if(await s(t),console.log(`[${new Date} next_date() finished]`),!i)return}i=!1,$("#play_button").show(),$("#stop_button").hide()}),$("#stop_button").click(()=>{i=!1,$("#play_button").show(),$("#stop_button").hide()})}()});
