"use strict";$(document).ready(async()=>{const t=d3.select("#svg_container"),e=await load_svg(t),n=new DataManager;let a,o,r,i,s=!1,c=!1,l=!1,u=!1;try{const t=url_param("u","Charlie Beta");await _(t)}catch(t){await _("Charlie Beta")}function d(){const t=n.get_max_event_date().substring(0,4);return n.user.dates.filter(e=>e.startsWith(t)).sort()[0]}function y(t){"string"==typeof t&&(t=[t]);for(const e of t)$("#"+e).css("opacity",1).css("pointer-events","auto")}function g(t){"string"==typeof t&&(t=[t]);for(const e of t)$("#"+e).css("opacity",.5).css("pointer-events","none")}async function h(){for(;c;)await sleep(500)}async function f(t){t instanceof Date&&(t=date_to_string(t));const a=(await n.get_routes(t)).map(t=>Object.assign(Object.assign({},t),{event:void 0}));a.sort((t,e)=>t.category==e.category?t.offset-e.offset:t.category>e.category?1:-1),avoid_collision.reset&&avoid_collision.reset();const o=await n.get_events(t),r={};o.forEach(t=>r[t.route_id]=t),$("#current_count").text(o.length+" events, "+a.length+" routes"),s&&(E(a),async function(){u=!0;const t=d3.timer((function(n){if(!u)return void t.stop();const a=M();let o=500,r=500;if(a.x>580&&a.x<620&&a.y>350){const t=Math.min(1,(a.y-350)/300);o=d3.interpolate(500,1200)(t),r=d3.interpolate(500,650)(t)}const i=Math.max(0,Math.min(1200-o,a.x-o/2)),s=Math.max(0,Math.min(650-r,a.y-r/2));e.attr("viewBox",`${i} ${s} ${o} ${r}`)}))}());for(let t=0;t<a.length;++t){const e=r[a[t].route_id];if(e){const n=Object.assign({},a[t]);if(n.event=e,a[t]=n,s&&(await k(n),z(n),E(a,n.id),await b(),await x(n),await h(),!s))return await T(),void p()}}if(s)return await T(),void p();await E(a)}function w(){return n.avatar.json.center}async function _(t){await n.set_user(t),a=d3.select(n.avatar.layer),await a.transition().duration(0).attrTween("transform",A("walkway-entrance",0,0)).end()}async function p(){u=!1}async function v(t,e){const a=n.avatar.json.sequence[t];for(const t of a){const a=[],o=null==t.duration?250:t.duration,r=d3[t.ease||"easeLinear"];for(const[i,s]of Object.entries(t))if("duration"!=i&&"ease"!=i)for(const t of n.avatar.json.states[i][s]){const n=d3.select("#"+t[0]),i=n.attr("transform");if(e&&e())return;n.interrupt(),a.push(n.transition().duration(o).ease(r).attrTween("transform",()=>d3.interpolate(i,t[1])).end())}try{await Promise.all(a)}catch(t){console.log(t)}}}async function m(){l=!1,await v("stop")}async function b(){await v("dance")}async function x(t){t.route_grade.match("^([vV](8|9|1\\d)|(5\\.12(b|c|d))|(5.1[345]).*)$")&&await async function(){await v("celebrate")}()}async function k(t){let e=void 0;if(void 0!==t.category){e=t.category;const n=t.wall;t=function(t,e,n){t={x:t.x,y:t.y};const a=document.getElementById(e),o=get_length_at_point(a,t),r=a.getPointAtLength(Math.min(o+10,a.getTotalLength())),i=a.getPointAtLength(Math.max(o-10,0)),s=-1/((r.y-i.y)/(r.x-i.x));let c,l;s==1/0||s==-1/0?(c=0,l=50):0==s?(c=50,l=0):(c=50*Math.sqrt(1/(1+s*s)),l=s*c);const u={x:t.x+c,y:t.y+l,original:t},d={x:t.x-c,y:t.y-l,original:t},y=O(t,n).walkway,g=get_length_at_point(y,u,!0).distance,h=get_length_at_point(y,d,!0).distance;return g<h?u:d}(t={x:avoid_collision(t).x,y:avoid_collision(t).y},n,e)}void 0===r&&(r="walkway-entrance",await a.transition().duration(0).attrTween("transform",A("walkway-entrance",0,0)).end(),await m(),$("#avatar-layer").show(),i=0);const n=function(t,e,n){const a=O(t,e);return function(t,e){if(t===e)return[[e]];return function t(n,a={}){function a(t,e){return e.result.filter(e=>e[0]==t).length>0}for(const t of n){const n=o[t.path][e];if(n)return t.result.concat([[e,n]])}const r=[];for(const t of n)for(const[e,n]of Object.entries(o[t.path]))if(!a(e,t)){const a={path:e,result:t.result.concat([[e,n]])};r.push(a)}return t(r)}([{path:t,result:[[t]]}])}(n,a.walkway).concat([[a.walkway,{length1:a.length,length2:a.length}]])}(t,e,r);if(async function(){l=!0;try{for(;l;)await v("walk",()=>!l)}catch(t){}}(),point_distance(M(),t)>50){void 0===i&&await P(r),n.shift()[0]!==r&&await P(r);for(const[t,e]of n)await B(r,i,e.length1),r=t,i=e.length2}if(await C(t),t.original){const e=d3.interpolate(M(),t.original);await C(e(.01))}await m()}async function T(){await k(document.getElementById("walkway-entrance").getPointAtLength(0))}function M(t,e){let n;return a.attr("transform")&&(n=a.attr("transform").match("translate\\((\\S+) (\\S+)\\)( rotate\\((\\S+))?")),{x:(n?parseFloat(n[1]):0)+w().x,y:(n?parseFloat(n[2]):0)+w().y}}function D(t){const e=M();return()=>{let n=e;return e=>{const a=t(e),o=function(t,e){const n=t.x-e.x,a=t.y-e.y;return Math.atan2(a,n)/Math.PI*180-90}(n,a),r=a.x-w().x,i=a.y-w().y;return n={x:a.x,y:a.y},`translate(${r} ${i}) rotate(${o} ${w().x} ${w().y})`}}}function A(t,e,n){t="string"==typeof t?document.getElementById(t):t;const a=d3.interpolate(e,n);return D(e=>t.getPointAtLength(a(e)))}function L(t){const e=M();return D(d3.interpolate(e,t))}async function B(t,e,n){t="string"==typeof t?document.getElementById(t):t;const o=I(Math.abs(n-e));await h(),"walkway-entrance"==t.getAttribute("id")&&(e<.001&&a.transition("visible").duration(o).ease(d3.easeExpOut).style("opacity",1),n<.001&&a.transition("visible").duration(o).ease(d3.easeExpIn).style("opacity",0)),await a.transition().duration(o).ease(d3.easeLinear).attrTween("transform",A(t,e,n)).end(),r=t.getAttribute("id"),i=n}async function C(t){await h(),await a.transition().duration(I(M(),t)).ease(d3.easeLinear).attrTween("transform",L(t)).end(),i=void 0}async function P(t){t="string"==typeof t?document.getElementById(t):t;const e=M(),n=get_length_at_point(t,e),o=t.getPointAtLength(n);await h(),await a.transition().duration(I(e,o)).ease(d3.easeLinear).attrTween("transform",L(o)).end(),r=t.getAttribute("id"),i=n}function I(t,e){return 3*(null==e?t:point_distance(t,e))}async function S(t,e){t=new Date(t.valueOf()),e=new Date(e.valueOf()),t.setUTCHours(18),e.setUTCHours(6);const n=Math.abs(e.getTime()-t.getTime())/864e5,a=d3.interpolate(t.getTime(),e.getTime()),o=[],r=1e3*Math.log2(1+n);$("#clock-layer").show(),o.push(d3.select("#clock_minute_hand").transition().duration(r).attrTween("transform",()=>t=>`rotate(${a(t)%36e5*360/36e5} 600 347)`).end()),o.push(d3.select("#clock_hour_hand").transition().duration(r).attrTween("transform",()=>t=>`rotate(${a(t)%432e5*360/432e5} 600 347)`).end()),o.push(d3.select("#clock-overlay").transition().duration(r).attrTween("opacity",()=>t=>{const e=new Date(a(t)),n=e.getUTCHours()+e.getUTCMinutes()/60+e.getUTCSeconds()/3600;return(Math.max(6,Math.abs(n-12))-6)/6*.3}).end()),o.push(d3.select("#clock-text-date").transition().duration(r).textTween(()=>t=>{const e=new Date(a(t));return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getUTCMonth()]} ${e.getUTCDate().toString().padStart(2,"0")}, ${e.getFullYear()}`}).end()),$("#clock-text").text(`+${Math.ceil(n)} ${n>1?"Days":"Day"}`),await Promise.all(o),$("#clock-layer").hide()}function O(t,e){let n,a,o;const r={"Routes Island High Bay Left":["walkway-lowbay-right"],"Routes Island Low Bay Right":["walkway-highbays"],"Routes Lead Cave":["walkway-lowbay-right"],"Bouldering 45":["walkway-mezzanine","walkway-fox"],"Bouldering Buddha":["walkway-mezzanine"],"Bouldering Slab":["walkway-fox"],"Routes Right of Auto Belay":["walkway-mezzanine"],"Routes Auto Belays":["walkway-mezzanine"]}[e];for(const e of $("#walkways-layer path")){if(r&&r.includes(e.getAttribute("id")))continue;const i=get_length_at_point(e,t,!0);(null==o||i.distance<o)&&(o=i.distance,n=e.getAttribute("id"),a=i.length)}return{walkway:n,length:a,distance:o}}async function z(t){const n={x:avoid_collision(t).x,y:avoid_collision(t).y},a=[],o=t.event.route_grade.match("^(5\\.)?(.*)")[2];a.push({color:"#800080",text:o}),1==t.event.rating&&a.push({href:"img/thumbsdown.png",width:50,height:50}),2==t.event.rating&&a.push({href:"img/thumbsdown.png"}),4==t.event.rating&&a.push({href:"img/thumbsup.png"}),5==t.event.rating&&a.push({href:"img/thumbsup.png",width:50,height:50}),t.event.comment.length>0&&a.push({href:"img/comment.png"}),"Flash"!=t.event.style&&"Onsight"!=t.event.style||a.push({href:"img/flash.png",height:28,width:25}),async function(t,n){let a=0;for(const o of t){if(o.duration=o.duration||2e3,o.width=o.width||30,o.height=o.height||30,o.href){const t=e.append("image");t.attr("href",o.href).attr("x",n.x-o.width/2).attr("y",n.y-o.height/2).attr("width",o.width).attr("height",o.height).attr("opacity",0).transition().delay(a).duration(o.duration).attr("y",n.y-50).attrTween("opacity",()=>t=>1-Math.abs(2*t-1)).on("end",()=>t.remove()).end()}else if(o.text){const t=e.append("circle");t.attr("fill",o.color).attr("cx",n.x).attr("cy",n.y).attr("r",o.r||12).attr("opacity",0).transition().delay(a).duration(o.duration).attr("cy",n.y-50).attr("opacity",1).attrTween("opacity",()=>t=>1-Math.abs(2*t-1)).on("end",()=>t.remove()).end();const r=e.append("text");r.attr("text-anchor","middle").attr("x",n.x).attr("y",n.y+5.4).attr("width",50).attr("height",12).attr("fill","white").attr("font-family","Roboto Condensed").attr("font-size","12.5px").attr("font-weight","bold").text(o.text).attr("opacity",0).transition().delay(a).duration(o.duration).attr("y",n.y-50+5.4).attr("opacity",1).attrTween("opacity",()=>t=>1-Math.abs(2*t-1)).on("end",()=>r.remove()).end()}a+=500}}(a,n)}async function E(t,e){const n=d3.select("#routes").selectAll("circle.route").data(t,t=>`${t.id}:${t.event?"1":"0"}`),a=e?t=>t.id==e:t=>!0;n.enter().append("circle").attr("class","route").attr("opacity",1).attr("fill",t=>get_color(t.route_color)).attr("fill-opacity",0).attr("stroke",t=>get_color(t.route_color)).attr("stroke-width",1).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).attr("r",t=>t.event?30:5).on("mouseover",t=>hover(t,avoid_collision(t))).on("mouseout",(t,e,n)=>{d3.select("#info_div").transition().delay(200).duration(100).style("opacity",0)}).on("dblclick",t=>window.open("https://www.vertical-life.info/en/indoor/the-cliffs-at-lic/climbs/"+t.route_id,"_blank")).filter(a).transition().duration(1e3).attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).end(),n.filter(a).transition().duration(1e3).attr("fill",t=>get_color(t.route_color)).attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).end(),n.exit().filter(a).transition().duration(1e3).attr("r",20).attr("opacity",0).remove().end(),await sleep(1e3)}$("#controls").show(),$("#avatar-layer").css("opacity",0),g(["stop_button","pause_button"]),await async function(){e.insert("g","#clock-layer").attr("id","events"),e.insert("g","#clock-layer").attr("id","routes"),o=function(){const t={},e=$("#walkways-layer path");for(const n of e){const a=n.getAttribute("id"),o=n.getPointAtLength(0),r=n.getPointAtLength(n.getTotalLength());let i,s;for(const c of e){const e=c.getAttribute("id");let l;n!==c&&(c.isPointInStroke(o)?(l=o,i=0):c.isPointInStroke(r)&&(l=r,i=n.getTotalLength()),l&&(s=get_length_at_point(c,l),t[a]=t[a]||{},t[e]=t[e]||{},t[a][e]={length1:i,length2:s},t[e][a]={length1:s,length2:i}))}}return t}(),$("#current_user").val(n.user.name);const t=new Pikaday({field:document.getElementById("current_date"),position:"top right",disableDayFn:t=>!n.has_event(date_to_string(t)),onSelect:t=>f(t)});function a(e){const a=t.getDate();do{if(e>0&&a>string_to_date(n.get_max_event_date()))return a;if(e<0&&a<string_to_date(n.get_min_event_date()))return a;a.setDate(a.getDate()+e)}while(!n.has_event(date_to_string(a)));return t.setDate(a,s),a}t.setDate(string_to_date(d())),$("#next_date").click(()=>a(1)),$("#previous_date").click(()=>a(-1)),$("#play_button").click(()=>async function(t,e){if(c)return s=!0,c=!1,g(["play_button","next_date","previous_date","current_date","current_user"]),void y(["stop_button","pause_button"]);g(["play_button","next_date","previous_date","current_date","current_user"]),y(["stop_button","pause_button"]),s=!0;for(;;){if(await f(t.getDate()),!s)break;const a=t.getDate(),o=e(1);if(a==o||o>string_to_date(n.get_max_event_date()))break;await S(a,o)}s=!1,await f(t.getDate()),y(["play_button","next_date","previous_date","current_date","current_user"]),g(["stop_button","pause_button"])}(t,a)),$("#pause_button").click(()=>{c=!0,s=!1,y("play_button"),g(["stop_button","pause_button"])}),$("#stop_button").click(()=>{s=!1,g(["stop_button","pause_button"])}),$("#current_user").focus(()=>{$('<div id="white-overlay"></div>').appendTo(document.body),$("#current_user").addClass("above-overlay"),$("#current_user").val("")}),$("#current_user").blur(async()=>{const e=$("#current_user").val().toLowerCase();try{""!=e&&e!=n.user.name&&(await _(e),t.setDate(string_to_date(d())),window.location.hash="u="+n.user.name)}catch(t){alert(`User "${e}" not found`)}finally{$("*:not(#current_user)").css("-webkit-filter",")"),$("#current_user").removeClass("above-overlay"),$("#white-overlay").remove(),$("#current_user").val(n.user.name)}}),$("#current_user").keypress((function(t){13==t.which&&$("#current_user").blur()}))}()});
