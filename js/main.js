"use strict";$(document).ready(async()=>{const t=d3.select("#svg_container"),a=await load_svg(t),e=new DataManager;let r,n,o,i,s=!1,c=!1,l=!1,d=!1;const u=597,g=660;try{const t=url_param("u","Charlie Beta");await m(t)}catch(t){await m("Charlie Beta")}function f(){const t=e.get_max_event_date().substring(0,4);return e.user.dates.filter(a=>a.startsWith(t)).sort()[0]}function h(t){"string"==typeof t&&(t=[t]);for(const a of t)$("#"+a).css("opacity",1).css("pointer-events","auto")}function _(t){"string"==typeof t&&(t=[t]);for(const a of t)$("#"+a).css("opacity",.5).css("pointer-events","none")}async function y(){for(;c;)await sleep(500)}async function w(t){t instanceof Date&&(t=date_to_string(t));const r=(await e.get_routes(t)).map(t=>Object.assign(Object.assign({},t),{event:void 0}));r.sort((t,a)=>t.category==a.category?t.offset-a.offset:t.category>a.category?1:-1),avoid_collision.reset&&avoid_collision.reset();const n=await e.get_events(t),o={};n.forEach(t=>o[t.route_id]=t),$("#current_count").text(n.length+" events, "+r.length+" routes"),s&&(U(r),async function(){d=!0;const t=d3.timer((function(e){if(!d)return void t.stop();const r=A();let n=500,o=500;if(r.x>580&&r.x<620&&r.y>350){const t=Math.min(1,(r.y-350)/300);n=d3.interpolate(500,1200)(t),o=d3.interpolate(500,650)(t)}const i=Math.max(0,Math.min(1200-n,r.x-n/2)),s=Math.max(0,Math.min(650-o,r.y-o/2));a.attr("viewBox",`${i} ${s} ${n} ${o}`)}))}());for(let t=0;t<r.length;++t){const a=o[r[t].route_id];if(a){const e=Object.assign({},r[t]);if(e.event=a,r[t]=e,s&&(await M(e),R(e),U(r,e.id),await x(),await T(e),await y(),!s))return await D(),void p()}}if(s)return await D(),void p();await U(r)}async function m(t){await e.set_user(t),r=d3.select(await load_avatar(a,e.user.name)),await r.transition().duration(0).attrTween("transform",L("walkway-entrance",0,0)).end()}async function v(t,a=200){const e=[];for(const[r,n]of Object.entries(t))for(const t of{left_leg:{forward:[["avatar-left-leg-forward","translate(0 0) scale(1 1)"],["avatar-left-leg-back","translate(0 327) scale(1 0.5)"]],back:[["avatar-left-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-left-leg-back","translate(0 0) scale(1 1)"]],center:[["avatar-left-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-left-leg-back","translate(0 327) scale(1 0.5)"]]},right_leg:{forward:[["avatar-right-leg-forward","translate(0 0) scale(1 1)"],["avatar-right-leg-back","translate(0 327) scale(1 0.5)"]],back:[["avatar-right-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-right-leg-back","translate(0 0) scale(1 1)"]],center:[["avatar-right-leg-forward","translate(0 340) scale(1 0.5)"],["avatar-right-leg-back","translate(0 327) scale(1 0.5)"]]},left_arm:{forward:[["avatar-left-arm-forward","translate(0 0) scale(1 1) rotate(0 576.5 662.5)"],["avatar-left-arm-back","translate(5 320) scale(1 0.5) rotate(0 576.5 662.5)"]],back:[["avatar-left-arm-forward","translate(0 366) scale(1 0.45) rotate(0 576.5 662.5)"],["avatar-left-arm-back","translate(0 0) scale(1 1) rotate(0 576.5 662.5)"]],center:[["avatar-left-arm-forward","translate(0 366) scale(1 0.45) rotate(0 576.5 662.5)"],["avatar-left-arm-back","translate(5 330) scale(1 0.5) rotate(0 576.5 662.5)"]],open:[["avatar-left-arm-forward","translate(0, 0) scale(1,1) rotate(-80 576.5 662.5)"]],extended:[["avatar-left-arm-forward","translate(0, 0) scale(1,1) rotate(0 576.5 662.5)"]]},right_arm:{forward:[["avatar-right-arm-forward","translate(0 0) scale(1 1) rotate(0 617.5 662.5)"],["avatar-right-arm-back","translate(-5 330) scale(1 0.5) rotate(0 617.5 662.5)"]],back:[["avatar-right-arm-forward","translate(0 366) scale(1 0.45) rotate(0 617.5 662.5)"],["avatar-right-arm-back","translate(0 0) scale(1 1) rotate(0 617.5 662.5)"]],center:[["avatar-right-arm-forward","translate(0 366) scale(1 0.45) rotate(0 617.5 662.5)"],["avatar-right-arm-back","translate(-5 330) scale(1 0.5) rotate(0 617.5 662.5)"]],open:[["avatar-right-arm-forward","translate(0, 0) scale(1,1) rotate(80 617.5 662.5)"]],extended:[["avatar-right-arm-forward","translate(0, 0) scale(1,1) rotate(0 617.5 662.5)"]]},head:{left:[["avatar-head","translate(-3 0)"]],right:[["avatar-head","translate(3 0)"]],center:[["avatar-head","translate(0 0)"]],center:[["avatar-head","translate(0 0)"]],left_forward:[["avatar-head","translate(-2 -7)"]],right_forward:[["avatar-head","translate(2 -7)"]],center_forward:[["avatar-head","translate(0 -7)"]]},torso:{right:[["avatar-torso",`rotate(-10 ${u} ${g})`]],left:[["avatar-torso",`rotate(10 ${u} ${g})`]],center:[["avatar-torso",`rotate(0 ${u} ${g})`]]}}[r][n]){const r=d3.select("#"+t[0]),n=r.attr("transform");r.interrupt(),e.push(r.transition().duration(a).ease(d3.easeLinear).attrTween("transform",()=>d3.interpolate(n,t[1])).end())}await Promise.all(e)}async function p(){d=!1}function b(){return"charlie beta"!=e.user.name}async function k(){l=!1;await v({right_arm:"center",left_arm:"center",right_leg:"center",left_leg:"center",head:"center",torso:"center"},0)}async function x(){const t=[{right_arm:"open",left_arm:"open"},{right_arm:"extended",left_arm:"extended"}];b()&&(d3.select("#avatar-left-arm-back").style("opacity",0),d3.select("#avatar-right-arm-back").style("opacity",0)),await v(t[0],50),await v(t[1],50),await v(t[0],50),await v(t[1],50),await v(t[0],50),await v(t[1],50),b()&&(d3.select("#avatar-left-arm-back").style("opacity",1),d3.select("#avatar-right-arm-back").style("opacity",1))}async function T(t){t.route_grade.match("^([vV](8|9|1\\d)|(5\\.12(b|c|d))|(5.1[345]).*)$")&&await async function(){const t=r.attr("transform");b()&&(d3.select("#avatar-left-arm-back").style("opacity",0),d3.select("#avatar-right-arm-back").style("opacity",0));v({right_arm:"open",left_arm:"open"},150),await r.transition().duration(1e3).attrTween("transform",()=>{const a=t.match("translate\\((.*?)\\) rotate\\((.*?) (.*?) (.*?)\\)");return t=>{const e=(parseFloat(a[2])+720*t)%360;return`translate(${a[1]}) rotate(${e} ${u} ${g})`}}).end(),await v({right_arm:"center",left_arm:"center"},150),b()&&(d3.select("#avatar-left-arm-back").style("opacity",1),d3.select("#avatar-right-arm-back").style("opacity",1))}()}async function M(t){let a=void 0;if(void 0!==t.category){a=t.category;const e=t.wall;t=function(t,a,e){t={x:t.x,y:t.y};const r=document.getElementById(a),n=get_length_at_point(r,t),o=r.getPointAtLength(Math.min(n+10,r.getTotalLength())),i=r.getPointAtLength(Math.max(n-10,0)),s=-1/((o.y-i.y)/(o.x-i.x));let c,l;s==1/0||s==-1/0?(c=0,l=50):0==s?(c=50,l=0):(c=50*Math.sqrt(1/(1+s*s)),l=s*c);const d={x:t.x+c,y:t.y+l,original:t},u={x:t.x-c,y:t.y-l,original:t},g=E(t,e).walkway,f=get_length_at_point(g,d,!0).distance,h=get_length_at_point(g,u,!0).distance;return f<h?d:u}(t={x:avoid_collision(t).x,y:avoid_collision(t).y},e,a)}void 0===o&&(o="walkway-entrance",await r.transition().duration(0).attrTween("transform",L("walkway-entrance",0,0)).end(),await k(),$("#avatar-layer").show(),i=0);const e=function(t,a,e){const r=E(t,a);return function(t,a){if(t===a)return[[a]];return function t(e,r={}){function r(t,a){return a.result.filter(a=>a[0]==t).length>0}for(const t of e){const e=n[t.path][a];if(e)return t.result.concat([[a,e]])}const o=[];for(const t of e)for(const[a,e]of Object.entries(n[t.path]))if(!r(a,t)){const r={path:a,result:t.result.concat([[a,e]])};o.push(r)}return t(o)}([{path:t,result:[[t]]}])}(e,r.walkway).concat([[r.walkway,{length1:r.length,length2:r.length}]])}(t,a,o);if(async function(){let t=[{right_arm:"forward",left_arm:"back",right_leg:"back",left_leg:"forward",head:"left",torso:"right"},{right_arm:"center",left_arm:"center",right_leg:"center",left_leg:"center",head:"center",torso:"center"},{right_arm:"back",left_arm:"forward",right_leg:"forward",left_leg:"back",head:"right",torso:"left"},{right_arm:"center",left_arm:"center",right_leg:"center",left_leg:"center",head:"center",torso:"center"}];b()&&(t=[{right_arm:"back",left_arm:"back",right_leg:"back",left_leg:"forward",head:"left_forward",torso:"right"},{right_arm:"back",left_arm:"back",right_leg:"center",left_leg:"center",head:"center_forward",torso:"center"},{right_arm:"back",left_arm:"back",right_leg:"forward",left_leg:"back",head:"right_forward",torso:"left"},{right_arm:"back",left_arm:"back",right_leg:"center",left_leg:"center",head:"center_forward",torso:"center"}]),l=!0;let a=0;try{for(;l;)await v(t[a]),a=(a+1)%t.length}catch(t){}}(),point_distance(A(),t)>50){void 0===i&&await S(o),e.shift()[0]!==o&&await S(o);for(const[t,a]of e)await P(o,i,a.length1),o=t,i=a.length2}if(await I(t),t.original){const a=d3.interpolate(A(),t.original);await I(a(.01))}await k()}async function D(){await M(document.getElementById("walkway-entrance").getPointAtLength(0))}function A(t,a){let e;return r.attr("transform")&&(e=r.attr("transform").match("translate\\((\\S+) (\\S+)\\)( rotate\\((\\S+))?")),{x:(e?parseFloat(e[1]):0)+u,y:(e?parseFloat(e[2]):0)+g}}function B(t){const a=A();return()=>{let e=a;return a=>{const r=t(a),n=function(t,a){const e=t.x-a.x,r=t.y-a.y;return Math.atan2(r,e)/Math.PI*180-90}(e,r),o=r.x-u,i=r.y-g;return e={x:r.x,y:r.y},`translate(${o} ${i}) rotate(${n} ${u} ${g})`}}}function L(t,a,e){t="string"==typeof t?document.getElementById(t):t;const r=d3.interpolate(a,e);return B(a=>t.getPointAtLength(r(a)))}function C(t){const a=A();return B(d3.interpolate(a,t))}async function P(t,a,e){t="string"==typeof t?document.getElementById(t):t;const n=O(Math.abs(e-a));await y(),"walkway-entrance"==t.getAttribute("id")&&(a<.001&&r.transition("visible").duration(n).ease(d3.easeExpOut).style("opacity",1),e<.001&&r.transition("visible").duration(n).ease(d3.easeExpIn).style("opacity",0)),await r.transition().duration(n).ease(d3.easeLinear).attrTween("transform",L(t,a,e)).end(),o=t.getAttribute("id"),i=e}async function I(t){await y(),await r.transition().duration(O(A(),t)).ease(d3.easeLinear).attrTween("transform",C(t)).end(),i=void 0}async function S(t){t="string"==typeof t?document.getElementById(t):t;const a=A(),e=get_length_at_point(t,a),n=t.getPointAtLength(e);await y(),await r.transition().duration(O(a,n)).ease(d3.easeLinear).attrTween("transform",C(n)).end(),o=t.getAttribute("id"),i=e}function O(t,a){return 3*(null==a?t:point_distance(t,a))}async function z(t,a){t=new Date(t.valueOf()),a=new Date(a.valueOf()),t.setUTCHours(18),a.setUTCHours(6);const e=Math.abs(a.getTime()-t.getTime())/864e5,r=d3.interpolate(t.getTime(),a.getTime()),n=[],o=1e3*Math.log2(1+e);$("#clock-layer").show(),n.push(d3.select("#clock_minute_hand").transition().duration(o).attrTween("transform",()=>t=>`rotate(${r(t)%36e5*360/36e5} 600 347)`).end()),n.push(d3.select("#clock_hour_hand").transition().duration(o).attrTween("transform",()=>t=>`rotate(${r(t)%432e5*360/432e5} 600 347)`).end()),n.push(d3.select("#clock-overlay").transition().duration(o).attrTween("opacity",()=>t=>{const a=new Date(r(t)),e=a.getUTCHours()+a.getUTCMinutes()/60+a.getUTCSeconds()/3600;return(Math.max(6,Math.abs(e-12))-6)/6*.3}).end()),n.push(d3.select("#clock-text-date").transition().duration(o).textTween(()=>t=>{const a=new Date(r(t));return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a.getUTCMonth()]} ${a.getUTCDate().toString().padStart(2,"0")}, ${a.getFullYear()}`}).end()),$("#clock-text").text(`+${Math.ceil(e)} ${e>1?"Days":"Day"}`),await Promise.all(n),$("#clock-layer").hide()}function E(t,a){let e,r,n;const o={"Routes Island High Bay Left":"walkway-lowbay-right","Routes Island Low Bay Right":"walkway-highbays","Routes Lead Cave":"walkway-lowbay-right","Bouldering 45":"walkway-mezzanine","Bouldering Buddha":"walkway-mezzanine","Bouldering Slab":"walkway-fox","Routes Right of Auto Belay":"walkway-mezzanine","Routes Auto Belays":"walkway-mezzanine"}[a];for(const a of $("#walkways-layer path")){if(a.getAttribute("id")===o)continue;const i=get_length_at_point(a,t,!0);(null==n||i.distance<n)&&(n=i.distance,e=a.getAttribute("id"),r=i.length)}return{walkway:e,length:r,distance:n}}async function R(t){const e={x:avoid_collision(t).x,y:avoid_collision(t).y},r=[],n=t.event.route_grade.match("^(5\\.)?(.*)")[2];r.push({color:"#800080",text:n}),1==t.event.rating&&r.push({href:"img/thumbsdown.png",width:50,height:50}),2==t.event.rating&&r.push({href:"img/thumbsdown.png"}),4==t.event.rating&&r.push({href:"img/thumbsup.png"}),5==t.event.rating&&r.push({href:"img/thumbsup.png",width:50,height:50}),t.event.comment.length>0&&r.push({href:"img/comment.png"}),"Flash"!=t.event.style&&"Onsight"!=t.event.style||r.push({href:"img/flash.png",height:28,width:25}),async function(t,e){let r=0;for(const n of t){if(n.duration=n.duration||2e3,n.width=n.width||30,n.height=n.height||30,n.href){const t=a.append("image");t.attr("href",n.href).attr("x",e.x-n.width/2).attr("y",e.y-n.height/2).attr("width",n.width).attr("height",n.height).attr("opacity",0).transition().delay(r).duration(n.duration).attr("y",e.y-50).attrTween("opacity",()=>t=>1-Math.abs(2*t-1)).on("end",()=>t.remove()).end()}else if(n.text){const t=a.append("circle");t.attr("fill",n.color).attr("cx",e.x).attr("cy",e.y).attr("r",n.r||12).attr("opacity",0).transition().delay(r).duration(n.duration).attr("cy",e.y-50).attr("opacity",1).attrTween("opacity",()=>t=>1-Math.abs(2*t-1)).on("end",()=>t.remove()).end();const o=a.append("text");o.attr("text-anchor","middle").attr("x",e.x).attr("y",e.y+5.4).attr("width",50).attr("height",12).attr("fill","white").attr("font-family","Roboto Condensed").attr("font-size","12.5px").attr("font-weight","bold").text(n.text).attr("opacity",0).transition().delay(r).duration(n.duration).attr("y",e.y-50+5.4).attr("opacity",1).attrTween("opacity",()=>t=>1-Math.abs(2*t-1)).on("end",()=>o.remove()).end()}r+=500}}(r,e)}async function U(t,a){const e=d3.select("#routes").selectAll("circle.route").data(t,t=>`${t.id}:${t.event?"1":"0"}`),r=a?t=>t.id==a:t=>!0;e.enter().append("circle").attr("class","route").attr("opacity",1).attr("fill",t=>get_color(t.route_color)).attr("fill-opacity",0).attr("stroke",t=>get_color(t.route_color)).attr("stroke-width",1).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).attr("r",t=>t.event?30:5).on("mouseover",t=>hover(t,avoid_collision(t))).on("mouseout",(t,a,e)=>{d3.select("#info_div").transition().delay(200).duration(100).style("opacity",0)}).on("dblclick",t=>window.open("https://www.vertical-life.info/en/indoor/the-cliffs-at-lic/climbs/"+t.route_id,"_blank")).filter(r).transition().duration(1e3).attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).end(),e.filter(r).transition().duration(1e3).attr("fill",t=>get_color(t.route_color)).attr("fill-opacity",t=>t.event?1:0).attr("stroke",t=>t.event?contrast_color("white",get_color(t.route_color)):get_color(t.route_color)).attr("stroke-width",t=>t.event?1.5:1).attr("r",5).attr("cx",t=>avoid_collision(t).x).attr("cy",t=>avoid_collision(t).y).end(),e.exit().filter(r).transition().duration(1e3).attr("r",20).attr("opacity",0).remove().end(),await sleep(1e3)}$("#controls").show(),$("#avatar-layer").css("opacity",0),_(["stop_button","pause_button"]),await async function(){a.insert("g","#clock-layer").attr("id","events"),a.insert("g","#clock-layer").attr("id","routes"),n=function(){const t={},a=$("#walkways-layer path");for(const e of a){const r=e.getAttribute("id"),n=e.getPointAtLength(0),o=e.getPointAtLength(e.getTotalLength());let i,s;for(const c of a){const a=c.getAttribute("id");let l;e!==c&&(c.isPointInStroke(n)?(l=n,i=0):c.isPointInStroke(o)&&(l=o,i=e.getTotalLength()),l&&(s=get_length_at_point(c,l),t[r]=t[r]||{},t[a]=t[a]||{},t[r][a]={length1:i,length2:s},t[a][r]={length1:s,length2:i}))}}return t}(),$("#current_user").val(e.user.name);const t=new Pikaday({field:document.getElementById("current_date"),position:"top right",disableDayFn:t=>!e.has_event(date_to_string(t)),onSelect:t=>w(t)});function r(a){const r=t.getDate();do{if(a>0&&r>string_to_date(e.get_max_event_date()))return r;if(a<0&&r<string_to_date(e.get_min_event_date()))return r;r.setDate(r.getDate()+a)}while(!e.has_event(date_to_string(r)));return t.setDate(r,s),r}t.setDate(string_to_date(f())),$("#next_date").click(()=>r(1)),$("#previous_date").click(()=>r(-1)),$("#play_button").click(()=>async function(t,a){if(c)return s=!0,c=!1,_(["play_button","next_date","previous_date","current_date","current_user"]),void h(["stop_button","pause_button"]);_(["play_button","next_date","previous_date","current_date","current_user"]),h(["stop_button","pause_button"]),s=!0;for(;;){if(await w(t.getDate()),!s)break;const r=t.getDate(),n=a(1);if(r==n||n>string_to_date(e.get_max_event_date()))break;await z(r,n)}s=!1,await w(t.getDate()),h(["play_button","next_date","previous_date","current_date","current_user"]),_(["stop_button","pause_button"])}(t,r)),$("#pause_button").click(()=>{c=!0,s=!1,h("play_button"),_(["stop_button","pause_button"])}),$("#stop_button").click(()=>{s=!1,_(["stop_button","pause_button"])}),$("#current_user").focus(()=>{$('<div id="white-overlay"></div>').appendTo(document.body),$("#current_user").addClass("above-overlay"),$("#current_user").val("")}),$("#current_user").blur(async()=>{try{$("#current_user").val()!=e.user.name&&(await m($("#current_user").val()),t.setDate(string_to_date(f())),window.location.hash="u="+e.user.name)}catch(t){alert(`User "${$("#current_user").val()}" not found`),$("#current_user").val(e.user.name)}finally{$("*:not(#current_user)").css("-webkit-filter",")"),$("#current_user").removeClass("above-overlay"),$("#white-overlay").remove()}}),$("#current_user").keypress((function(t){13==t.which&&$("#current_user").blur()}))}()});
